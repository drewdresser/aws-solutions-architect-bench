name: Nightly Benchmark

on:
  schedule:
    - cron: "0 5 * * *"    # daily 05:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

jobs:
  bench:
    runs-on: ubuntu-latest
    env:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}

      - name: Sync Python deps
        run: uv sync

      - name: Nightly bench run
        run: |
          make bench.daily
          make board.json

      - name: Show leaderboard (Job Summary)
        if: always()
        run: |
          echo "## Leaderboard (Top 10)" >> $GITHUB_STEP_SUMMARY
          if [ -f results/leaderboard.csv ]; then
            echo '' >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -n 11 results/leaderboard.csv >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "_No leaderboard produced_" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-results-${{ github.run_id }}
          path: |
            logs/**
            results/**
          if-no-files-found: warn

      # --- Build a tiny static site for GitHub Pages ---
      - name: Build site bundle
        if: always()
        run: |
          mkdir -p site
          cp results/leaderboard.csv site/ || true
          cp results/leaderboard.json site/ || true
          cat > site/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>AWS SA Bench – Leaderboard</title>
            <style>
              body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; color:#111;}
              h1 { margin: 0 0 0.5rem 0; }
              .meta { color:#555; margin-bottom:1rem; }
              table { border-collapse: collapse; width: 100%; }
              th, td { border: 1px solid #ddd; padding: .5rem; text-align: left; }
              th { cursor: pointer; user-select: none; background: #fafafa; }
              tr:nth-child(even){ background: #fcfcfc; }
              code { background: #f4f4f4; padding: 0 .2rem; border-radius: 4px; }
            </style>
          </head>
          <body>
            <h1>Leaderboard</h1>
            <div class="meta">
              Latest <code>results/leaderboard.csv</code>. Click headers to sort. Deployed from nightly CI.
            </div>
            <div id="table-wrap">Loading…</div>
            <script>
              async function load() {
                try {
                  const res = await fetch('leaderboard.csv', {cache: 'no-store'});
                  if (!res.ok) throw new Error('CSV not foun
