name: Nightly Benchmark

on:
  schedule:
    - cron: "0 5 * * *"    # daily 05:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

jobs:
  bench:
    runs-on: ubuntu-latest
    env:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}

      - name: Sync Python deps
        run: uv sync

      - name: Setup Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK CLI
        run: |
          npm install -g aws-cdk
          cdk --version

      - name: Run tests
        run: make test

      - name: Nightly bench run
        run: |
          # Use local CDK task (no Docker sandbox) for CI reliability
          make bench.daily CDK_TASK="evals/cdk_synth/tasks.py:aws_cdk_synth_local"
          make board.json

      - name: Show leaderboard (Job Summary)
        if: always()
        run: |
          echo "## Leaderboard (Top 10)" >> $GITHUB_STEP_SUMMARY
          if [ -f results/leaderboard.csv ]; then
            echo '' >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -n 11 results/leaderboard.csv >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "_No leaderboard produced_" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-results-${{ github.run_id }}
          path: |
            logs/**
            results/**
          if-no-files-found: warn

      # --- Bundle evaluation logs for viewing ---
      - name: Bundle evaluation logs
        run: |
          # Bundle logs for static viewing (gracefully handles missing logs)
          ./scripts/bundle_logs.sh || echo "Log bundling skipped (no logs or error)"

      # --- Build static site for GitHub Pages ---
      - name: Build site bundle
        run: |
          mkdir -p site
          cp docs/index.html site/
          cp results/leaderboard.csv site/ || true
          cp results/leaderboard.json site/ || true

          # Copy bundled logs if they exist
          if [ -d docs/logs ]; then
            cp -r docs/logs site/
            echo "Bundled logs copied to site/logs/"
          else
            echo "No bundled logs to copy"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # Separate job for deployment (requires environment)
  deploy:
    needs: bench
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
